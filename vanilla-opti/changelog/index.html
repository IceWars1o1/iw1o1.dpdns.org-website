<!DOCTYPE html>
<html lang="zh-CN">
<head>
	<meta name="viewport" content="width=device-width,initial-scale=1">
	<meta charset="UTF-8">
	<title>更新日志</title>
	<style>
        /* 1. ASCII 专用（0000-007F） */
        @font-face {
          font-family: 'Mojangles';
          src: url('/assets/font/Mojangles.woff2') format('woff2');
          unicode-range: U+0000-007F;          /* 仅 ASCII */
          font-weight: normal;
          font-style: normal;
        }
        
        /* 2. 非 ASCII 用 Unifont */
        @font-face {
          font-family: 'Unifont';
          src: url('/assets/font/Unifont.woff2') format('woff2');
          unicode-range: U+0080-10FFFF;        /* 除 ASCII 外的所有字符 */
          font-weight: normal;
          font-style: normal;
        }
		:root{
		  --accent:#0078d4;
		  --bg:#f5f7fa;
		  --card:#ffffff;
		  --text:#222;
		  --muted:#666;
		  --radius:10px;
		  --shadow:0 4px 18px rgba(0,0,0,.08);
		  --font:Mojangles,Unifont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
		}
		*{box-sizing:border-box;margin:0;padding:0}
		html{line-height:1.6;-webkit-font-smoothing:antialiased}
		body{
		  font-family:var(--font);
		  background:var(--bg);
		  color:var(--text);
		  padding:20px;
		}
		.log-container{
		  max-width:800px;
		  margin:auto;
		  background:var(--card);
		  border-radius:var(--radius);
		  box-shadow:var(--shadow);
		  padding:28px 32px;
		}
		h2{
		  font-size:1.8rem;
		  margin-bottom:24px;
		  color:var(--accent);
		  text-align:center;
		}
		.log-item{
		  margin-bottom:24px;
		  border-left:4px solid var(--accent);
		  padding-left:16px;
		}
		.log-version{
		  font-weight:700;
		  font-size:1.15rem;
		  color:var(--accent);
		  margin-bottom:4px;
		}
		.log-content{
		  white-space:pre-wrap;
		  word-break:break-word;
		  color:var(--text);
		  line-height:1.65;
		}
		.loading{
		  text-align:center;
		  color:var(--muted);
		  font-size:1rem;
		}
		
		/* 响应式微调 */
		@media(max-width:600px){
		  body{padding:12px}
		  .log-container{padding:20px 22px}
		  h2{font-size:1.5rem}
		  .log-item{margin-bottom:18px}
		}
		  /* ===== MC 颜色 ===== */
		  .mc-0 { color:#000000; }  .mc-bg-0 { background:#000000; }
		  .mc-1 { color:#0000AA; }  .mc-bg-1 { background:#00002A; }
		  .mc-2 { color:#00AA00; }  .mc-bg-2 { background:#002A00; }
		  .mc-3 { color:#00AAAA; }  .mc-bg-3 { background:#002A2A; }
		  .mc-4 { color:#AA0000; }  .mc-bg-4 { background:#2A0000; }
		  .mc-5 { color:#AA00AA; }  .mc-bg-5 { background:#2A002A; }
		  .mc-6 { color:#FFAA00; }  .mc-bg-6 { background:#402A00; }
		  .mc-7 { color:#AAAAAA; }  .mc-bg-7 { background:#2A2A2A; }
		  .mc-8 { color:#555555; }  .mc-bg-8 { background:#151515; }
		  .mc-9 { color:#5555FF; }  .mc-bg-9 { background:#15153F; }
		  .mc-a { color:#55FF55; }  .mc-bg-a { background:#153F15; }
		  .mc-b { color:#55FFFF; }  .mc-bg-b { background:#153F3F; }
		  .mc-c { color:#FF5555; }  .mc-bg-c { background:#3F1515; }
		  .mc-d { color:#FF55FF; }  .mc-bg-d { background:#3F153F; }
		  .mc-e { color:#FFFF55; }  .mc-bg-e { background:#3F3F15; }
		  .mc-f { color:#FFFFFF; }  .mc-bg-f { background:#3F3F3F; }
		  /* 基岩版材料色 */
		  .mc-g { color:#DDD605; } .mc-bg-g { background:#373501; }
		  .mc-h { color:#E3D4D1; } .mc-bg-h { background:#383534; }
		  .mc-i { color:#CECACA; } .mc-bg-i { background:#333232; }
		  .mc-j { color:#443A3B; } .mc-bg-j { background:#110E0E; }
		  .mc-m { color:#971607; } .mc-bg-m { background:#250501; }
		  .mc-n { color:#B4684D; } .mc-bg-n { background:#2D1A13; }
		  .mc-p { color:#DEB12D; } .mc-bg-p { background:#372C0B; }
		  .mc-q { color:#47A036; } .mc-bg-q { background:#04280D; }
		  .mc-s { color:#2CBAA8; } .mc-bg-s { background:#0B2E2A; }
		  .mc-t { color:#21497B; } .mc-bg-t { background:#08121E; }
		  .mc-u { color:#9A5CC6; } .mc-bg-u { background:#261731; }
		  .mc-v { color:#EB7114; } .mc-bg-v { background:#3B1D05; }
		  
		  /* ===== MC 格式 ===== */
		  .mc-bold { font-weight:bold; }
		  .mc-italic { font-style:italic; }
		  .mc-underline { text-decoration:underline; }
		  .mc-strike { text-decoration:line-through; }
		  .mc-random { /* 随机乱码效果 */
		    display:inline-block;
		    animation: mcRandom .25s steps(1) infinite;
		  }
		  @keyframes mcRandom {
		    0% { opacity:1; }
		    50% { opacity:.6; }
		  }
		
	</style>
</head>
<body>
	<div class="log-container">
		<h2>更新日志</h2>
		<div id="logs">加载中...</div>
	</div>
	<script>
		async function loadLogs() {
		  const container = document.getElementById('logs');
		  container.innerHTML = '<div class="loading">加载中...</div>';
		  try {
		    const res = await fetch('/changelog/dev/api/logs', {
		      method: 'POST',
		      headers: {
		        'X-API-Key': 'miku_dream_2025_secure_api_v1',
		        'X-Request-Type': 'logs',
		        'Content-Type': 'application/json'
		      }
		    });
		    const json = await res.json();
		    if (!json.success || !Array.isArray(json.data)) throw new Error('格式异常');
		
		    // data 已经按 id 倒序（最新在前），无需再 reverse
		    container.innerHTML = '';
		    json.data.forEach(item=>{
		      const div = document.createElement('div');
		      div.className = 'log-item';
		      let content = item.content
		  .replace(/\\n/g,'\n')
		  .replace(/\\u[\dA-Fa-f]{4}/g, m=>String.fromCharCode(parseInt(m.slice(2),16)));
		        content = colorizeMC(content);   // ← 新增
		        div.innerHTML = `<div class="log-version">${item.version}</div><div class="log-content">${content}</div>`;
		        
		      container.appendChild(div);
		    });
		  } catch (e) {
		    container.innerHTML = `<div class="loading">加载失败：${e.message}</div>`;
		  }
		  
		}
		
		function colorizeMC(raw, asBlock = false) {
          const colorMap = {
            '0':'0','1':'1','2':'2','3':'3','4':'4','5':'5','6':'6','7':'7','8':'8','9':'9',
            'a':'a','b':'b','c':'c','d':'d','e':'e','f':'f',
            'g':'g','h':'h','i':'i','j':'j','m':'m','n':'n','p':'p','q':'q','s':'s','t':'t','u':'u','v':'v'
          };
          const formatMap = { 'k':'random','l':'bold','m':'strike','n':'underline','o':'italic','r':'reset' };
        
          let html = '';
        
          // ✅ 按行拆，每行之前自动加 §r，实现“换行还原样式”
          const lines = raw.split('\n');
        
          for (let i = 0; i < lines.length; i++) {
            if (i > 0) html += '<br>';
        
            let line = lines[i];
            let curColor = '';
            let curFmt = new Set();
        
            function open() {
              const cls = [];
              if (curColor) cls.push('mc-' + curColor);
              curFmt.forEach(f => cls.push('mc-' + f));
              return cls.length ? `<span class="${cls.join(' ')}">` : '';
            }
        
            function wrap(text) {
              if (!text && text !== 0) return '';
              const o = open();
              return o ? o + text + '</span>' : text;
            }
        
            // ✅ 每行之前自动加 §r，实现“还原样式”
            line = '§r' + line;
        
            const parts = line.split(/(§[0-9a-fk-or])/gi);
            for (let j = 0; j < parts.length; j++) {
              const p = parts[j];
              if (!p) continue;
        
              if (p[0] === '§') {
                const code = p[1].toLowerCase();
                if (colorMap[code]) {
                  curColor = colorMap[code];
                  curFmt.clear();
                } else if (formatMap[code]) {
                  if (code === 'r') {
                    curColor = '';
                    curFmt.clear();
                  } else {
                    curFmt.add(formatMap[code]);
                  }
                }
                continue;
              }
        
              html += wrap(p);
            }
          }
        
          return asBlock ? `<div>${html}</div>` : html;
        }
        
		loadLogs();
	</script>
</body>

</html>